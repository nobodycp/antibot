{% extends "base.html" %}
{% load slugify_filters %}

{% block title %}Denied Logs{% endblock %}

{% block content %}
<h1 class="text-base font-semibold mb-4 text-white border-b border-zinc-700 pb-1 flex items-center justify-between">
  <span>ðŸš« Denied Logs</span>
  <span class="text-xs font-normal text-zinc-400">Total: {{ logs|length }}</span>
</h1>

<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-4">
  <div class="flex items-center gap-2">
    <form method="post" class="flex flex-wrap items-center gap-2" onsubmit="return confirm('Are you sure you want to delete all logs?');">
      {% csrf_token %}
      <input type="hidden" name="delete_all" value="1">
      <div class="relative group">
        <button type="submit" class="text-red-500 hover:text-red-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <title>Delete All</title>
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m2 0a2 2 0 00-2-2H9a2 2 0 00-2 2h10z" />
          </svg>
        </button>
        <div class="absolute left-full top-1/2 -translate-y-1/2 ml-2 bg-zinc-800 text-white text-[10px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">Delete All</div>
      </div>
    </form>

    <div class="relative group">
      <a href="#" hx-get="{% url 'denied_logs_table' %}" hx-target="#logs-table" hx-swap="outerHTML" class="text-blue-400 hover:text-blue-600">
        <svg title="Refresh" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <title>Refresh</title>
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v6h6M20 20v-6h-6M4 20l16-16" />
        </svg>
      </a>
      <div class="absolute left-full top-1/2 -translate-y-1/2 ml-2 bg-zinc-800 text-white text-[10px] px-2 py-0.5 rounded opacity-0 group-hover:opacity-100 transition whitespace-nowrap">Refresh</div>
    </div>
  </div>

  <form method="get" class="w-full md:max-w-xs ml-auto">
    <input type="text" placeholder="Search logs..." value="{{ request.GET.search }}" name="search"
           oninput="this.form.submit()"
           class="px-3 py-1 bg-zinc-800 border border-zinc-600 rounded text-xs text-white w-full focus:outline-none focus:ring-1 focus:ring-purple-500" />
  </form>
</div>

{% if messages %}
  <div class="space-y-2 mb-4">
    {% for message in messages %}
      <div class="px-3 py-1.5 rounded-md text-xs {{ message.tags }}
                  {% if message.tags == 'success' %}bg-green-600 text-white
                  {% elif message.tags == 'warning' %}bg-yellow-600 text-white
                  {% elif message.tags == 'error' %}bg-red-600 text-white
                  {% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<div class="rounded overflow-hidden border border-zinc-700">
  <table class="w-full bg-zinc-800 text-xs">
    <thead class="bg-zinc-700 text-left text-zinc-300 uppercase tracking-wide">
      <tr>
        <th class="px-3 py-2">Time</th>
        <th class="px-3 py-2">IP</th>
        <th class="px-3 py-2">Reason</th>
        <th class="px-3 py-2">ISP</th>
        <th class="px-3 py-2">Hostname</th>
        <th class="px-3 py-2">OS</th>
        <th class="px-3 py-2">Browser</th>
        <th class="px-3 py-2">Country</th>
        <th class="px-3 py-2 text-right">Delete</th>
      </tr>
    </thead>
    <tbody id="logs-table">
      {% for log in logs %}
      <tr class="border-b border-zinc-700 hover:bg-zinc-700/30">
        <td class="px-3 py-1.5 text-zinc-400">{{ log.timestamp|timesince }} ago</td>
        <td class="px-3 py-1.5 text-zinc-100 font-mono">{{ log.ip_address }}</td>
        <td class="px-3 py-1.5 text-red-400 font-semibold">{{ log.reason }}</td>
        <td class="px-3 py-1.5 text-zinc-100">{{ log.isp }}</td>
        <td class="px-3 py-1.5 text-zinc-100">{{ log.hostname }}</td>
        <td class="px-3 py-1.5 text-zinc-100">
          <span class="flex items-center gap-2">
            <img src="/static/icons/os/{{ log.os|icon_name }}.svg" alt="os icon" class="w-4 h-4 inline-block align-middle" />
            <span class="align-middle">{{ log.os }}</span>
          </span>
        </td>
        <td class="px-3 py-1.5 text-zinc-100">
          <span class="flex items-center gap-2">
            <img src="/static/icons/browsers/{{ log.browser|icon_name }}.svg" alt="browser icon" class="w-4 h-4 inline-block align-middle" />
            <span class="align-middle">{{ log.browser }}</span>
          </span>
        </td>
        <td class="px-3 py-1.5 text-zinc-100 flex items-center gap-2">
          {% if log.country %}
          <img src="https://flagcdn.com/24x18/{{ log.country|lower }}.png" alt="{{ log.country }} flag" class="w-4 h-3 rounded-sm border border-zinc-600" />
          {% endif %}
          <span>{{ log.country }}</span>
        </td>
        <td class="px-3 py-1.5 text-right">
          <form method="post" class="inline">
            {% csrf_token %}
            <input type="hidden" name="delete_id" value="{{ log.id }}">
            <button type="submit" class="text-red-500 hover:text-red-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m2 0a2 2 0 00-2-2H9a2 2 0 00-2 2h10z" />
              </svg>
            </button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="9" class="px-3 py-4 text-zinc-400 text-center">No denied logs found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
